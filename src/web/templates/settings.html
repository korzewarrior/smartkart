{% extends "base.html" %}

{% block title %}SmartKart - Settings{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">Settings</div>
    
    <form id="settings-form">
        <div class="form-group">
            <label class="form-label" for="speech-volume">Speech Volume</label>
            <div style="display: flex; align-items: center; gap: 15px;">
                <input type="range" id="speech-volume" name="speech_volume" min="0" max="100" value="{{ settings.speech_volume }}" class="form-control" style="flex: 1;">
                <span id="volume-value">{{ settings.speech_volume }}%</span>
                <button type="button" id="test-volume" class="btn btn-info">Test</button>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="speech-rate">Speech Rate</label>
            <div style="display: flex; align-items: center; gap: 15px;">
                <input type="range" id="speech-rate" name="speech_rate" min="50" max="300" value="{{ settings.speech_rate }}" class="form-control" style="flex: 1;">
                <span id="rate-value">{{ settings.speech_rate }}</span>
                <button type="button" id="test-rate" class="btn btn-info">Test</button>
            </div>
        </div>
        
        {% if voices %}
        <div class="form-group">
            <label class="form-label" for="voice">Voice</label>
            <select id="voice" name="voice" class="form-control">
                <option value="">Default Voice</option>
                {% for voice in voices %}
                <option value="{{ voice.id }}" {% if settings.voice == voice.id %}selected{% endif %}>{{ voice.name }}</option>
                {% endfor %}
            </select>
            <button type="button" id="test-voice" class="btn btn-info" style="margin-top: 10px;">Test Voice</button>
        </div>
        {% endif %}
        
        <div class="form-group" style="margin-top: 30px;">
            <button type="submit" class="btn btn-success">Save Settings</button>
            <button type="button" id="reset-settings" class="btn btn-danger">Reset to Defaults</button>
        </div>
    </form>
</div>

<!-- Success Alert -->
<div id="success-alert" class="alert alert-success" style="display: none; margin-top: 20px;">
    Settings have been saved successfully.
</div>

<!-- Reset Confirmation Modal -->
<div id="reset-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center;">
    <div class="card" style="max-width: 400px; width: 90%;">
        <div class="card-header">Confirm Reset</div>
        <div style="padding: 20px;">
            <p>Are you sure you want to reset all settings to their default values?</p>
        </div>
        <div style="padding: 15px; display: flex; justify-content: flex-end; gap: 10px; border-top: 2px solid var(--dark);">
            <button id="cancel-reset-btn" class="btn btn-secondary">Cancel</button>
            <button id="confirm-reset-btn" class="btn btn-danger">Reset Settings</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const settingsForm = document.getElementById('settings-form');
        const speechVolume = document.getElementById('speech-volume');
        const volumeValue = document.getElementById('volume-value');
        const speechRate = document.getElementById('speech-rate');
        const rateValue = document.getElementById('rate-value');
        const testVolumeBtn = document.getElementById('test-volume');
        const testRateBtn = document.getElementById('test-rate');
        const testVoiceBtn = document.getElementById('test-voice');
        const voiceSelect = document.getElementById('voice');
        const resetSettingsBtn = document.getElementById('reset-settings');
        const successAlert = document.getElementById('success-alert');
        const resetModal = document.getElementById('reset-modal');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');
        const confirmResetBtn = document.getElementById('confirm-reset-btn');
        
        // Update volume value display
        speechVolume.addEventListener('input', function() {
            volumeValue.textContent = this.value + '%';
        });
        
        // Update rate value display
        speechRate.addEventListener('input', function() {
            rateValue.textContent = this.value;
        });
        
        // Test volume
        testVolumeBtn.addEventListener('click', function() {
            if ('speechSynthesis' in window) {
                const volume = parseFloat(speechVolume.value) / 100;
                const utterance = new SpeechSynthesisUtterance('Testing volume level');
                utterance.volume = volume;
                window.speechSynthesis.speak(utterance);
            } else {
                alert('Speech synthesis is not supported in your browser.');
            }
        });
        
        // Test rate
        testRateBtn.addEventListener('click', function() {
            if ('speechSynthesis' in window) {
                const rate = parseFloat(speechRate.value) / 175; // Adjust to match backend rate
                const utterance = new SpeechSynthesisUtterance('Testing speech rate');
                utterance.rate = rate;
                window.speechSynthesis.speak(utterance);
            } else {
                alert('Speech synthesis is not supported in your browser.');
            }
        });
        
        // Test voice
        if (testVoiceBtn) {
            testVoiceBtn.addEventListener('click', function() {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance('This is a test of the selected voice');
                    
                    if (voiceSelect && voiceSelect.value) {
                        // Try to find the voice in the available voices
                        const voices = window.speechSynthesis.getVoices();
                        for (let i = 0; i < voices.length; i++) {
                            if (voices[i].voiceURI === voiceSelect.value) {
                                utterance.voice = voices[i];
                                break;
                            }
                        }
                    }
                    
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('Speech synthesis is not supported in your browser.');
                }
            });
        }
        
        // Handle form submission
        settingsForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Get form values
            const settings = {
                speech_volume: speechVolume.value,
                speech_rate: speechRate.value
            };
            
            if (voiceSelect) {
                settings.voice = voiceSelect.value;
            }
            
            // Send settings to server
            fetch('/api/update_settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    successAlert.style.display = 'block';
                    
                    // Hide after 3 seconds
                    setTimeout(() => {
                        successAlert.style.display = 'none';
                    }, 3000);
                } else {
                    alert('Error saving settings. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error saving settings:', error);
                alert('Error saving settings. Please try again.');
            });
        });
        
        // Show reset confirmation modal
        resetSettingsBtn.addEventListener('click', function() {
            resetModal.style.display = 'flex';
        });
        
        // Cancel reset
        cancelResetBtn.addEventListener('click', function() {
            resetModal.style.display = 'none';
        });
        
        // Close reset modal when clicking outside of it
        resetModal.addEventListener('click', function(event) {
            if (event.target === resetModal) {
                resetModal.style.display = 'none';
            }
        });
        
        // Confirm reset
        confirmResetBtn.addEventListener('click', function() {
            // Set default values
            speechVolume.value = 100;
            volumeValue.textContent = '100%';
            
            speechRate.value = 175;
            rateValue.textContent = '175';
            
            if (voiceSelect) {
                voiceSelect.value = '';
            }
            
            // Submit the form with default values
            const event = new Event('submit');
            settingsForm.dispatchEvent(event);
            
            // Hide the modal
            resetModal.style.display = 'none';
        });
    });
</script>
{% endblock %} 